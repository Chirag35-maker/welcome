{% schema %}
{
  "name": "Welcome Popup",
  "target": "body",
  "stylesheet": "welcome-popup.css",
  "javascript": "welcome-popup.js",
  "settings": [
    {
      "type": "text",
      "id": "popup_title",
      "label": "Popup Title",
      "default": "Welcome to our store!"
    },
    {
      "type": "text",
      "id": "popup_message",
      "label": "Popup Message",
      "default": "Subscribe to our newsletter for exclusive offers and updates."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Subscribe Button Text",
      "default": "Subscribe"
    }
  ]
}
{% endschema %}

<div id="welcome-popup" class="welcome-popup">
  <div class="welcome-popup-content">
    <button class="close-button" onclick="closePopup()">&times;</button>
    <h2>{{ block.settings.popup_title }}</h2>
    <p>{{ block.settings.popup_message }}</p>
    <form id="email-form" class="newsletter-form">
      <input 
        type="email" 
        name="contact[email]"
        id="email-input" 
        placeholder="Enter your email" 
        required
      >
      <button type="submit">{{ block.settings.button_text }}</button>
      <div id="success-message" style="display: none; color: green;">
        Thank you for subscribing!
      </div>
      <div id="error-message" style="display: none; color: red;">
        Something went wrong. Please try again.
      </div>
    </form>
  </div>
</div>

<style>
.welcome-popup {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}

.welcome-popup-content {
  background-color: white;
  padding: 2rem;
  border-radius: 8px;
  max-width: 400px;
  width: 90%;
  position: relative;
}

.close-button {
  position: absolute;
  top: 10px;
  right: 10px;
  border: none;
  background: none;
  font-size: 24px;
  cursor: pointer;
}

.newsletter-form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: 1rem;
}

input[type="email"] {
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 100%;
}

button[type="submit"] {
  padding: 0.5rem 1rem;
  background-color: #000;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
}

button[type="submit"]:hover {
  background-color: #333;
}

button[type="submit"]:disabled {
  background-color: #666;
  cursor: not-allowed;
}
</style>

<script>
  // Show popup after 3 seconds
  window.addEventListener('load', function() {
    setTimeout(() => {
      const popup = document.getElementById('welcome-popup');
      if (popup) {
        popup.style.display = 'flex';
      }
    }, 3000);
  });

  function closePopup() {
    const popup = document.getElementById('welcome-popup');
    if (popup) {
      popup.style.display = 'none';
    }
  }

  // Handle form submission
  const form = document.getElementById('email-form');
  if (form) {
    form.addEventListener('submit', function(event) {
      event.preventDefault();
      
      const emailInput = document.getElementById('email-input');
      const successMessage = document.getElementById('success-message');
      const errorMessage = document.getElementById('error-message');
      const submitButton = event.target.querySelector('button[type="submit"]');
      
      // Reset messages
      successMessage.style.display = 'none';
      errorMessage.style.display = 'none';
      
      // Disable submit button
      submitButton.disabled = true;
      submitButton.textContent = 'Subscribing...';

      // First save to our server
      fetch('/apps/welcome/api/welcome-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          email: emailInput.value
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          successMessage.style.display = 'block';
          emailInput.value = '';
          setTimeout(() => {
            closePopup();
          }, 2000);
        } else {
          throw new Error(data.error || 'Failed to subscribe');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        errorMessage.style.display = 'block';
      })
      .finally(() => {
        // Re-enable submit button
        submitButton.disabled = false;
        submitButton.textContent = '{{ block.settings.button_text }}';
      });
    });
  }
</script> 